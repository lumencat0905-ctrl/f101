<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>F1 Ultimate Edition</title>
    <style>
        body {
            margin: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            font-family: Arial;
        }
        canvas {
            background: #222;
            border: 4px solid #fff;
            margin-top: 20px;
            border-radius: 10px;
        }
        #hud {
            margin-top: 10px;
            font-size: 20px;
            text-align: center;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        #resetBtn { background: #ff4444; color: white; }
        #pauseBtn { background: #44aaff; color: white; }
    </style>
</head>
<body>
    <h1>F1 Ultimate Edition üèéÔ∏èüî•</h1>
    <div id="hud">ÈÄüÂ∫¶Ôºö0 km/h ÔΩú ÂúàÊï∏Ôºö0</div>
    <canvas id="game" width="900" height="500"></canvas>
    <div>
        <button id="resetBtn">Reset</button>
        <button id="pauseBtn">Pause</button>
    </div>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");

        let car = {
            x: 450,
            y: 250,
            angle: 0,
            speed: 0,
            maxSpeed: 7,
            accel: 0.2,
            turnRate: 0.05,
        };

        let keys = {};
        let paused = false;
        let laps = 0;
        let lapStart = performance.now();
        let bestLap = null;

        document.addEventListener("keydown", e => keys[e.key] = true);
        document.addEventListener("keyup", e => keys[e.key] = false);

        function drawTrack() {
            ctx.strokeStyle = "#aaa";
            ctx.lineWidth = 8;
            ctx.beginPath();
            const p = [
                [200, 80], [700, 80], [780, 150], [780, 240], [720, 300], [650, 340],
                [600, 380], [500, 420], [400, 420], [300, 380], [240, 330], [180, 260],
                [160, 180], [180, 120]
            ];
            ctx.moveTo(p[0][0], p[0][1]);
            for (let i = 1; i < p.length; i++) ctx.lineTo(p[i][0], p[i][1]);
            ctx.closePath();
            ctx.stroke();
        }

        function drawCar() {
            ctx.save();
            ctx.translate(car.x, car.y);
            ctx.rotate(car.angle);
            ctx.fillStyle = "#1E2BC3";
            ctx.fillRect(-15, -8, 30, 16);
            ctx.restore();
        }

        function function updateCar() {
            if (keys["ArrowUp"]) car.speed = Math.min(car.speed + car.accel, car.maxSpeed);
            if (keys["ArrowDown"]) car.speed = Math.max(car.speed - car.accel, -car.maxSpeed / 2);
            if (keys["ArrowLeft"]) car.angle -= car.turnRate;
            if (keys["ArrowRight"]) car.angle += car.turnRate;

            let nextX = car.x + Math.cos(car.angle) * car.speed;
            let nextY = car.y + Math.sin(car.angle) * car.speed;

            // --- Èà¥ÈπøË≥ΩÈÅìÈÇäÁïåÁ∞°ÊòìÁ¢∞ÊíûÂÅµÊ∏¨ÔºöË∂ÖÂá∫Ë∑ØÁ∑öÂ∞±Ê∏õÈÄü ---
            if (!ctx.isPointInStroke) {
                car.x = nextX;
                car.y = nextY;
                return;
            }

            ctx.lineWidth = 20;
            drawTrack();
            if (!ctx.isPointInStroke(nextX, nextY)) {
                car.speed *= 0.7; // ÊíûÁâÜÊ∏õÈÄü
            } else {
                car.x = nextX;
                car.y = nextY;
            }

            // --- ÁµÇÈªûÁ∑öÔºàÂà§ÂÆöÂúàÊï∏Ôºâ---
            if (car.y < 85 && car.x > 195 && car.x < 705) {
                let now = performance.now();
                let lapTime = (now - lapStart) / 1000;
                if (lapTime > 3) {
                    laps++;
                    if (!bestLap || lapTime < bestLap) bestLap = lapTime;
                    lapStart = now;
                }
            }
        }() {
            if (keys["ArrowUp"]) car.speed = Math.min(car.speed + car.accel, car.maxSpeed);
            if (keys["ArrowDown"]) car.speed = Math.max(car.speed - car.accel, -car.maxSpeed / 2);
            if (keys["ArrowLeft"]) car.angle -= car.turnRate;
            if (keys["ArrowRight"]) car.angle += car.turnRate;

            car.x += Math.cos(car.angle) * car.speed;
            car.y += Math.sin(car.angle) * car.speed;

            if (car.x < 60 || car.x > 840 || car.y < 60 || car.y > 440) {
                car.speed *= 0.9;
            }
        }

        function function updateHUD() {
            let now = performance.now();
            let lapTime = ((now - lapStart) / 1000).toFixed(2);
            let best = bestLap ? bestLap.toFixed(2) : "--";
            document.getElementById("hud").textContent = `ÈÄüÂ∫¶Ôºö${Math.round(car.speed * 30)} km/h ÔΩú ÂúàÊï∏Ôºö${laps} ÔΩú Êú¨ÂúàÔºö${lapTime}s ÔΩú ÊúÄ‰Ω≥Ôºö${best}s`;
        }() {
            document.getElementById("hud").textContent = `ÈÄüÂ∫¶Ôºö${Math.round(car.speed * 30)} km/h ÔΩú ÂúàÊï∏Ôºö${laps}`;
        }

        function loop() {
            if (!paused) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawTrack();
                updateCar();
                drawCar();
                updateHUD();
            }
            requestAnimationFrame(loop);
        }

        document.getElementById("resetBtn").onclick = () => {
            car.x = 450;
            car.y = 250;
            car.angle = 0;
            car.speed = 0;
            laps = 0;
        };

        document.getElementById("pauseBtn").onclick = () => paused = !paused;

        loop();
    // --- AI CAR ---
        let ai = {
            x: 450,
            y: 150,
            angle: 0,
            speed: 4,
            waypoint: 0,
            path: [
                {x: 450, y: 80},
                {x: 820, y: 80},
                {x: 820, y: 420},
                {x: 80, y: 420},
                {x: 80, y: 80}
            ]
        };

        function drawAI(){
            ctx.save();
            ctx.translate(ai.x, ai.y);
            ctx.rotate(ai.angle);
            ctx.fillStyle = "yellow";
            ctx.fillRect(-15, -8, 30, 16);
            ctx.restore();
        }

        function updateAI(){
            let wp = ai.path[ai.waypoint];
            let dx = wp.x - ai.x;
            let dy = wp.y - ai.y;
            let targetAngle = Math.atan2(dy, dx);
            
            let diff = targetAngle - ai.angle;
            if(diff > Math.PI) diff -= 2*Math.PI;
            if(diff < -Math.PI) diff += 2*Math.PI;

            ai.angle += diff * 0.03;

            ai.x += Math.cos(ai.angle) * ai.speed;
            ai.y += Math.sin(ai.angle) * ai.speed;

            if(Math.hypot(dx, dy) < 20){
                ai.waypoint = (ai.waypoint + 1) % ai.path.length;
            }
        }

        // integrate AI into loop
        const oldLoop = loop;
        function loop(){
            if (!paused) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawTrack();
                updateCar();
                drawCar();
                updateAI();
                drawAI();
                updateHUD();
            }
            requestAnimationFrame(loop);
        }

    </script>
</body>
</html>
